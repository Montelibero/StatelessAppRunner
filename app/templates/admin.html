<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Generator Pro</title>

    <!-- Подключаем Bulma CSS 1.0 (поддерживает авто-тему) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">

    <!-- Подключаем иконки Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Небольшие доработки, так как Bulma минималистична */
        .textarea-code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            min-height: 250px;
        }

        /* Анимации для уведомлений и результатов */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Контейнер для уведомлений (Toasts) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Стиль для прогресс-бара лимита */
        .limit-progress-wrapper {
            width: 100px;
            height: 6px;
            background-color: var(--bulma-background-weak);
            border-radius: 99px;
            overflow: hidden;
        }
        .limit-progress-bar {
            height: 100%;
            background-color: var(--bulma-link);
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        /* --- Красивый Toggle Switch --- */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }
        .slider {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            background-color: var(--bulma-border); /* Цвет выключенного состояния */
            border-radius: 34px;
            transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: 8px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: var(--bulma-scheme-main); /* Цвет кругляшка */
            border-radius: 50%;
            transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Состояние Checked */
        .toggle-switch input:checked + .slider {
            background-color: var(--bulma-link); /* Цвет включенного (синий) */
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(20px);
        }
        /* Ховер эффект для интерактивности */
        .toggle-switch:hover .slider {
            filter: brightness(0.95);
        }
    </style>
</head>
<body>

    <section class="section">
        <div class="container is-max-desktop">

            <div class="box">
                <!-- Header -->
                <div class="level is-mobile mb-5 pb-4" style="border-bottom: 1px solid var(--bulma-border);">
                    <div class="level-left">
                        <div class="level-item">
                            <span class="icon is-large has-text-link">
                                <i class="ph ph-link" style="font-size: 32px;"></i>
                            </span>
                        </div>
                        <div class="level-item">
                            <h1 class="title is-4">Генератор ссылок</h1>
                        </div>
                    </div>
                    <div class="level-right">
                        <span class="tag is-light is-rounded font-monospace">v2.0 Beta</span>
                    </div>
                </div>

                <!-- Form -->
                <div class="block">

                    <!-- Secret Key -->
                    <div class="field">
                        <label class="label">
                            Секретный ключ
                            <span class="icon is-small has-text-grey-light ml-1" title="Должен совпадать с ENV на сервере" style="cursor: help;">
                                <i class="ph ph-question"></i>
                            </span>
                        </label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input is-medium" type="password" id="key" placeholder="Введите ваш секретный ключ">
                            <span class="icon is-small is-left">
                                <i class="ph ph-key"></i>
                            </span>
                            <span class="icon is-small is-right" style="pointer-events: all; cursor: pointer;" onclick="toggleKeyVisibility()">
                                <i class="ph ph-eye" id="eye-icon"></i>
                            </span>
                        </div>
                    </div>

                    <!-- Code Editor -->
                    <div class="field mt-5">
                        <div class="level is-mobile mb-2">
                            <div class="level-left">
                                <label class="label mb-0">HTML Код приложения</label>
                            </div>
                            <div class="level-right">
                                <!-- Красивый Toggle Switch вместо старого чекбокса -->
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compress">
                                    <span class="slider"></span>
                                    <span class="is-size-7 has-text-weight-medium">Сжимать (Gzip)</span>
                                </label>
                            </div>
                        </div>
                        <div class="control">
                            <textarea class="textarea textarea-code" id="code" placeholder="<!DOCTYPE html>..."></textarea>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="field mt-6">
                        <div class="control">
                            <button id="generate-btn" class="button is-link is-fullwidth is-medium" onclick="generate()">
                                <span class="icon">
                                    <i class="ph ph-magic-wand"></i>
                                </span>
                                <span>Сгенерировать ссылку</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Result Area -->
                <article class="message is-link mt-6 is-hidden animate-slide-in" id="result">
                    <div class="message-header">
                        <p>Готово</p>

                        <!-- Limit Indicator inside Header -->
                        <div class="is-flex is-align-items-center">
                            <span class="is-size-7 mr-2">
                                <span id="len-info">0</span> / 8193 байт
                            </span>
                            <div class="limit-progress-wrapper">
                                <div id="limit-bar" class="limit-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="message-body">
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <div class="box has-background-scheme-main-ter p-3"
                                     style="border: 1px solid var(--bulma-border); word-break: break-all; max-height: 200px; overflow-y: auto; font-family: monospace;">
                                    <span id="link-text" class="is-size-7"></span>
                                </div>
                            </div>
                        </div>

                        <div class="buttons is-right">
                            <a id="link-anchor" href="#" target="_blank" class="button is-small is-outlined is-link">
                                <span class="icon"><i class="ph ph-arrow-square-out"></i></span>
                                <span>Открыть</span>
                            </a>
                            <button class="button is-small is-link" onclick="copyLink()">
                                <span class="icon"><i class="ph ph-copy"></i></span>
                                <span>Копировать</span>
                            </button>
                        </div>
                    </div>
                </article>

            </div>

            <p class="has-text-centered is-size-7 has-text-grey mt-4">
                Powered by MTL Mini Apps
            </p>
        </div>
    </section>

    <!-- Toasts Container -->
    <div id="toast-container"></div>

    <script>
        // Toggle Password Visibility
        function toggleKeyVisibility() {
            const input = document.getElementById('key');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('ph-eye', 'ph-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('ph-eye-slash', 'ph-eye');
            }
        }

        // Bulma-style Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            // Map types to Bulma colors
            const colorClass = type === 'error' ? 'is-danger' : 'is-success';
            const iconClass = type === 'error' ? 'ph-warning-circle' : 'ph-check-circle';

            toast.className = `notification ${colorClass} toast animate-slide-in is-light`;
            toast.innerHTML = `
                <button class="delete" onclick="this.parentElement.remove()"></button>
                <div class="is-flex is-align-items-center">
                    <span class="icon mr-2"><i class="ph ${iconClass} is-size-5"></i></span>
                    <span class="has-text-weight-medium">${message}</span>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function generate() {
            const btn = document.getElementById('generate-btn');
            const originalBtnContent = btn.innerHTML;

            // Loading State
            btn.disabled = true;
            btn.classList.add('is-loading');

            const key = document.getElementById('key').value;
            const code = document.getElementById('code').value;
            const compress = document.getElementById('compress').checked;

            if (!code) {
                showToast('Пожалуйста, введите HTML код', 'error');
                resetBtn(btn, originalBtnContent);
                return;
            }

            try {
                let data;

                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, html: code, compress })
                    });
                    if (!response.ok) throw new Error('API Error');
                    data = await response.json();
                } catch (e) {
                    // Fallback for UI Preview
                    console.warn("API недоступен в превью, используем мок-данные");
                    await new Promise(r => setTimeout(r, 800));
                    if (window.location.hostname.includes('googleusercontent') || location.protocol === 'file:') {
                         showToast('Демо режим: Backend недоступен', 'error');
                         throw new Error("Backend not connected");
                    }
                    throw e;
                }

                updateUI(data.url);
                showToast('Ссылка успешно сгенерирована!');

            } catch (error) {
                console.error(error);
                showToast('Ошибка: ' + error.message, 'error');
            } finally {
                resetBtn(btn, originalBtnContent);
            }
        }

        function updateUI(url) {
            const resultDiv = document.getElementById('result');
            const linkText = document.getElementById('link-text');
            const linkAnchor = document.getElementById('link-anchor');
            const lenInfo = document.getElementById('len-info');
            const limitBar = document.getElementById('limit-bar');

            resultDiv.classList.remove('is-hidden');
            linkText.innerText = url;
            linkAnchor.href = url;
            lenInfo.innerText = url.length;

            // Logic for limit bar
            const limit = 8193;
            const percentage = Math.min((url.length / limit) * 100, 100);
            limitBar.style.width = `${percentage}%`;

            // Colors via Bulma CSS variables or direct styles
            if (percentage > 90) {
                limitBar.style.backgroundColor = 'var(--bulma-danger)';
            } else if (percentage > 70) {
                limitBar.style.backgroundColor = 'var(--bulma-warning)';
            } else {
                limitBar.style.backgroundColor = 'var(--bulma-link)';
            }
        }

        function resetBtn(btn, content) {
            btn.disabled = false;
            btn.classList.remove('is-loading');
            btn.innerHTML = content;
        }

        function copyLink() {
            const text = document.getElementById('link-text').innerText;
            if (!text) return;

            navigator.clipboard.writeText(text).then(() => {
                showToast('Ссылка скопирована');
            }).catch(err => {
                showToast('Не удалось скопировать', 'error');
            });
        }
    </script>
</body>
</html>
