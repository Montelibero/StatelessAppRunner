<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Generator Pro</title>

    <!-- Подключаем Bulma CSS 1.0 (поддерживает авто-тему) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">

    <!-- Подключаем иконки Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Небольшие доработки, так как Bulma минималистична */
        .textarea-code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            min-height: 250px;
        }

        /* Анимации для уведомлений и результатов */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Контейнер для уведомлений (Toasts) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Стиль для прогресс-бара лимита */
        .limit-progress-wrapper {
            width: 100px;
            height: 6px;
            background-color: var(--bulma-background-weak);
            border-radius: 99px;
            overflow: hidden;
        }
        .limit-progress-bar {
            height: 100%;
            background-color: var(--bulma-link);
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        /* --- Красивый Toggle Switch --- */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }
        .slider {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            background-color: var(--bulma-border); /* Цвет выключенного состояния */
            border-radius: 34px;
            transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: 8px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: var(--bulma-scheme-main); /* Цвет кругляшка */
            border-radius: 50%;
            transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Состояние Checked */
        .toggle-switch input:checked + .slider {
            background-color: var(--bulma-link); /* Цвет включенного (синий) */
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(20px);
        }
        /* Ховер эффект для интерактивности */
        .toggle-switch:hover .slider {
            filter: brightness(0.95);
        }
    </style>
</head>
<body>

    <section class="section">
        <div class="container is-max-desktop">

            <div class="box">
                <!-- Header -->
                <div class="level is-mobile mb-5 pb-4" style="border-bottom: 1px solid var(--bulma-border);">
                    <div class="level-left">
                        <div class="level-item">
                            <span class="icon is-large has-text-link">
                                <i class="ph ph-link" style="font-size: 32px;"></i>
                            </span>
                        </div>
                        <div class="level-item">
                            <h1 class="title is-4">Генератор ссылок</h1>
                        </div>
                    </div>
                    <div class="level-right">
                        <span class="tag is-light is-rounded font-monospace">v2.1 Beta</span>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs is-centered">
                    <ul>
                        <li class="is-active" id="tab-generate" onclick="switchTab('generate')"><a>Генератор</a></li>
                        <li id="tab-saved" onclick="switchTab('saved')"><a>Сохраненные (DB)</a></li>
                        <li id="tab-users" onclick="switchTab('users')" class="is-hidden"><a>Пользователи</a></li>
                    </ul>
                </div>

                <!-- Form -->
                <div class="block">

                    <!-- Secret Key (Global) -->
                    <div class="field">
                        <label class="label">
                            Секретный ключ
                            <span class="icon is-small has-text-grey-light ml-1" title="Ваш личный ключ авторизации" style="cursor: help;">
                                <i class="ph ph-question"></i>
                            </span>
                        </label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input is-medium" type="password" id="key" placeholder="Введите ваш секретный ключ" onchange="onKeyChange()">
                            <span class="icon is-small is-left">
                                <i class="ph ph-key"></i>
                            </span>
                            <span class="icon is-small is-right" style="pointer-events: all; cursor: pointer;" onclick="toggleKeyVisibility()">
                                <i class="ph ph-eye" id="eye-icon"></i>
                            </span>
                        </div>
                    </div>

                    <!-- Code Editor (Shared) -->
                    <div class="field mt-5">
                        <div class="level is-mobile mb-2">
                            <div class="level-left">
                                <label class="label mb-0">HTML Код приложения</label>
                            </div>
                            <div class="level-right">
                                <!-- Красивый Toggle Switch вместо старого чекбокса -->
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compress">
                                    <span class="slider"></span>
                                    <span class="is-size-7 has-text-weight-medium">Сжимать (Gzip)</span>
                                </label>
                            </div>
                        </div>
                        <div class="control">
                            <textarea class="textarea textarea-code" id="code" placeholder="<!DOCTYPE html>..."></textarea>
                        </div>
                    </div>

                    <!-- Generate Tab Actions -->
                    <div id="content-generate">
                        <div class="field mt-6">
                            <div class="control">
                                <button id="generate-btn" class="button is-link is-fullwidth is-medium" onclick="generate()">
                                    <span class="icon">
                                        <i class="ph ph-magic-wand"></i>
                                    </span>
                                    <span>Сгенерировать ссылку</span>
                                </button>
                            </div>
                        </div>

                        <!-- Result Area (Generate) -->
                        <article class="message is-link mt-6 is-hidden animate-slide-in" id="result">
                            <div class="message-header">
                                <p>Готово</p>
                                <!-- Limit Indicator inside Header -->
                                <div class="is-flex is-align-items-center">
                                    <span class="is-size-7 mr-2">
                                        <span id="len-info">0</span> / 8193 байт
                                    </span>
                                    <div class="limit-progress-wrapper">
                                        <div id="limit-bar" class="limit-progress-bar"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="message-body">
                                <div class="field has-addons">
                                    <div class="control is-expanded">
                                        <div class="box has-background-scheme-main-ter p-3"
                                             style="border: 1px solid var(--bulma-border); word-break: break-all; max-height: 200px; overflow-y: auto; font-family: monospace;">
                                            <span id="link-text" class="is-size-7"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="buttons is-right">
                                    <a id="link-anchor" href="#" target="_blank" class="button is-small is-outlined is-link">
                                        <span class="icon"><i class="ph ph-arrow-square-out"></i></span>
                                        <span>Открыть</span>
                                    </a>
                                    <button class="button is-small is-link" onclick="copyLink()">
                                        <span class="icon"><i class="ph ph-copy"></i></span>
                                        <span>Копировать</span>
                                    </button>
                                </div>
                            </div>
                        </article>
                    </div>

                    <!-- Saved Apps Tab Actions -->
                    <div id="content-saved" class="is-hidden">
                        <div class="field has-addons mt-4">
                            <div class="control is-expanded">
                                <input class="input" type="text" id="app-slug" placeholder="Имя ссылки (например, my-app)">
                            </div>
                            <div class="control">
                                 <button class="button is-light" id="reset-btn" onclick="resetAppForm()" title="Сбросить / Новый">
                                    <span class="icon"><i class="ph ph-arrow-counter-clockwise"></i></span>
                                 </button>
                            </div>
                            <div class="control">
                                <button class="button is-primary" id="save-btn" onclick="saveApp()">
                                    <span class="icon"><i class="ph ph-floppy-disk"></i></span>
                                    <span>Сохранить</span>
                                </button>
                            </div>
                        </div>
                        <p class="help mb-5" id="editing-status">Приложение будет доступно по адресу <code>/p{id}/{имя}</code></p>

                        <h2 class="title is-5 mt-6">Сохраненные приложения</h2>
                        <div id="apps-list" class="mt-4">
                            <p class="has-text-grey-light is-italic">Введите ключ чтобы увидеть приложения...</p>
                        </div>
                    </div>

                    <!-- Users Tab Actions -->
                    <div id="content-users" class="is-hidden">
                         <h2 class="title is-5 mt-4">Управление Пользователями</h2>

                         <div class="box has-background-light">
                            <div class="field">
                                <label class="label">Новый Ключ</label>
                                <div class="control has-addons">
                                    <a class="button is-static">mini</a>
                                    <input class="input" type="text" id="new-user-key" placeholder="uuid...">
                                    <div class="control">
                                        <button class="button is-info" onclick="generateUUIDKey()">
                                            <span class="icon"><i class="ph ph-arrows-clockwise"></i></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Комментарий</label>
                                <div class="control">
                                    <input class="input" type="text" id="new-user-comment" placeholder="Имя пользователя или описание">
                                </div>
                            </div>
                            <button class="button is-primary is-fullwidth" onclick="createUser()">Создать пользователя</button>
                         </div>

                         <h3 class="title is-6 mt-5">Список ключей</h3>
                         <div id="users-list">
                             <p class="has-text-grey-light">Загрузка...</p>
                         </div>
                    </div>

                </div>

            </div>

            <p class="has-text-centered is-size-7 has-text-grey mt-4">
                Powered by MTL Mini Apps
            </p>
        </div>
    </section>

    <!-- Toasts Container -->
    <div id="toast-container"></div>

    <script>
        // Toggle Password Visibility
        function toggleKeyVisibility() {
            const input = document.getElementById('key');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('ph-eye', 'ph-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('ph-eye-slash', 'ph-eye');
            }
        }

        // Bulma-style Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colorClass = type === 'error' ? 'is-danger' : 'is-success';
            const iconClass = type === 'error' ? 'ph-warning-circle' : 'ph-check-circle';

            toast.className = `notification ${colorClass} toast animate-slide-in is-light`;
            toast.innerHTML = `
                <button class="delete" onclick="this.parentElement.remove()"></button>
                <div class="is-flex is-align-items-center">
                    <span class="icon mr-2"><i class="ph ${iconClass} is-size-5"></i></span>
                    <span class="has-text-weight-medium">${message}</span>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        let currentTab = 'generate';
        let currentAppOwnerId = null;

        function switchTab(tabName) {
            currentTab = tabName;
            // Tabs
            document.querySelectorAll('.tabs li').forEach(li => li.classList.remove('is-active'));
            document.getElementById(`tab-${tabName}`).classList.add('is-active');

            // Content
            document.getElementById('content-generate').classList.add('is-hidden');
            document.getElementById('content-saved').classList.add('is-hidden');
            document.getElementById('content-users').classList.add('is-hidden');
            document.getElementById(`content-${tabName}`).classList.remove('is-hidden');

            if (tabName === 'saved') {
                loadApps();
            } else if (tabName === 'users') {
                loadUsers();
            }
        }

        function onKeyChange() {
             const key = document.getElementById('key').value;
             if (currentTab === 'saved') loadApps();
             if (currentTab === 'users') loadUsers();

             // Check if Admin to show Users tab
             checkAdmin(key);
        }

        async function checkAdmin(key) {
            if(!key) return;
            // Optimistically try to fetch users. If 200, show tab.
            try {
                const response = await fetch(`/api/users?key=${encodeURIComponent(key)}`);
                if(response.ok) {
                    document.getElementById('tab-users').classList.remove('is-hidden');
                } else {
                    document.getElementById('tab-users').classList.add('is-hidden');
                }
            } catch(e) {
                document.getElementById('tab-users').classList.add('is-hidden');
            }
        }

        function resetAppForm() {
            document.getElementById('app-slug').value = '';
            document.getElementById('code').value = '';
            currentAppOwnerId = null;
            updateEditingStatus();
            showToast("Форма очищена");
        }

        function updateEditingStatus() {
            const status = document.getElementById('editing-status');
            if (currentAppOwnerId) {
                status.innerHTML = `Редактирование приложения пользователя ID <b>${currentAppOwnerId}</b>`;
                status.classList.add('has-text-info');
            } else {
                status.innerHTML = `Новое приложение (будет сохранено для вас)`;
                status.classList.remove('has-text-info');
            }
        }

        // --- Generate Logic ---

        async function generate() {
            const btn = document.getElementById('generate-btn');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('is-loading');

            const key = document.getElementById('key').value;
            const code = document.getElementById('code').value;
            const compress = document.getElementById('compress').checked;

            if (!code) {
                showToast('Пожалуйста, введите HTML код', 'error');
                resetBtn(btn, originalBtnContent);
                return;
            }

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, html: code, compress })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'API Error');
                }
                const data = await response.json();
                updateUI(data.url);
                showToast('Ссылка успешно сгенерирована!');
            } catch (error) {
                console.error(error);
                showToast('Ошибка: ' + error.message, 'error');
            } finally {
                resetBtn(btn, originalBtnContent);
            }
        }

        function updateUI(url) {
            const resultDiv = document.getElementById('result');
            const linkText = document.getElementById('link-text');
            const linkAnchor = document.getElementById('link-anchor');
            const lenInfo = document.getElementById('len-info');
            const limitBar = document.getElementById('limit-bar');

            resultDiv.classList.remove('is-hidden');
            linkText.innerText = url;
            linkAnchor.href = url;
            lenInfo.innerText = url.length;

            const limit = 8193;
            const percentage = Math.min((url.length / limit) * 100, 100);
            limitBar.style.width = `${percentage}%`;
            if (percentage > 90) limitBar.style.backgroundColor = 'var(--bulma-danger)';
            else if (percentage > 70) limitBar.style.backgroundColor = 'var(--bulma-warning)';
            else limitBar.style.backgroundColor = 'var(--bulma-link)';
        }

        function resetBtn(btn, content) {
            btn.disabled = false;
            btn.classList.remove('is-loading');
            btn.innerHTML = content;
        }

        function copyLink() {
            const text = document.getElementById('link-text').innerText;
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Ссылка скопирована');
            }).catch(err => {
                showToast('Не удалось скопировать', 'error');
            });
        }

        // --- Saved Apps Logic ---

        async function loadApps() {
            const listDiv = document.getElementById('apps-list');
            const key = document.getElementById('key').value;

            if(!key) {
                 listDiv.innerHTML = '<p class="has-text-grey">Введите ключ чтобы увидеть приложения.</p>';
                 return;
            }

            try {
                const response = await fetch(`/api/apps?key=${encodeURIComponent(key)}`);
                if (!response.ok) throw new Error('Ошибка доступа или неверный ключ');

                const apps = await response.json();

                if (apps.length === 0) {
                    listDiv.innerHTML = '<p class="has-text-grey">Нет сохраненных приложений.</p>';
                    return;
                }

                let html = '<div class="table-container"><table class="table is-fullwidth is-hoverable is-striped"><thead><tr><th>Slug</th><th>URL</th><th>Updated</th><th>Actions</th></tr></thead><tbody>';

                apps.forEach(app => {
                    const date = new Date(app.updated_at + 'Z').toLocaleString();
                    // Construct URL
                    let urlPath = '';
                    if (app.user_id === 1) {
                         urlPath = `/p/${app.slug}`;
                    } else {
                         urlPath = `/p${app.user_id}/${app.slug}`;
                    }

                    html += `
                        <tr>
                            <td class="has-text-weight-bold">${app.slug}</td>
                            <td><a href="${urlPath}" target="_blank" class="is-size-7">${urlPath}</a></td>
                            <td class="is-size-7">${date}</td>
                            <td>
                                <div class="buttons are-small">
                                    <button class="button is-info is-light" onclick="editApp('${app.slug}', ${app.user_id})" title="Редактировать">
                                        <span class="icon"><i class="ph ph-pencil-simple"></i></span>
                                    </button>
                                    <button class="button is-danger is-light" onclick="deleteApp('${app.slug}', ${app.user_id})" title="Удалить">
                                        <span class="icon"><i class="ph ph-trash"></i></span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                listDiv.innerHTML = html;

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = `<p class="has-text-danger">${e.message}</p>`;
            }
        }

        async function saveApp() {
            const btn = document.getElementById('save-btn');
            const originalBtnContent = btn.innerHTML;
            btn.classList.add('is-loading');
            btn.disabled = true;

            const key = document.getElementById('key').value;
            const slug = document.getElementById('app-slug').value;
            const code = document.getElementById('code').value;

            if (!key) {
                showToast('Нужен секретный ключ', 'error');
                resetBtn(btn, originalBtnContent);
                return;
            }
            if (!slug) {
                showToast('Укажите имя ссылки (slug)', 'error');
                resetBtn(btn, originalBtnContent);
                return;
            }
            if (!code) {
                showToast('Код пустой!', 'error');
                resetBtn(btn, originalBtnContent);
                return;
            }

            try {
                const response = await fetch('/api/apps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, slug, html: code, owner_id: currentAppOwnerId })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Ошибка сохранения');
                }

                showToast('Приложение сохранено!');
                loadApps(); // Refresh list

            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                resetBtn(btn, originalBtnContent);
            }
        }

        async function editApp(slug, ownerId) {
            try {
                const key = document.getElementById('key').value;
                let url = `/api/apps/${slug}?key=${encodeURIComponent(key)}`;
                if(ownerId) url += `&target_user_id=${ownerId}`;

                const response = await fetch(url);

                if (!response.ok) throw new Error('Не удалось загрузить приложение');
                const data = await response.json();

                document.getElementById('code').value = data.html_content;
                document.getElementById('app-slug').value = data.slug;

                currentAppOwnerId = ownerId;
                updateEditingStatus();

                showToast(`Загружено: ${slug}`);
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function deleteApp(slug, ownerId) {
            if (!confirm(`Вы уверены, что хотите удалить ${slug}?`)) return;

            const key = document.getElementById('key').value;
            if (!key) {
                showToast('Введите секретный ключ для удаления', 'error');
                return;
            }

            let url = `/api/apps/${slug}`;
            if(ownerId) url += `?target_user_id=${ownerId}`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, owner_id: ownerId })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Ошибка удаления');
                }

                showToast('Удалено');
                loadApps();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // --- Users Logic ---

        function generateUUIDKey() {
            const uuid = crypto.randomUUID();
            document.getElementById('new-user-key').value = uuid;
        }

        async function loadUsers() {
            const key = document.getElementById('key').value;
            if (!key) return;

            const listDiv = document.getElementById('users-list');

            try {
                const response = await fetch(`/api/users?key=${encodeURIComponent(key)}`);
                if(!response.ok) throw new Error("Нет доступа");

                const users = await response.json();
                let html = '<table class="table is-fullwidth is-striped"><thead><tr><th>ID</th><th>Key</th><th>Comment</th></tr></thead><tbody>';
                users.forEach(u => {
                    html += `<tr>
                        <td>${u.id}</td>
                        <td class="is-family-monospace">${u.key}</td>
                        <td>${u.comment || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listDiv.innerHTML = html;
            } catch(e) {
                listDiv.innerHTML = `<p class="has-text-danger">${e.message}</p>`;
            }
        }

        async function createUser() {
            const adminKey = document.getElementById('key').value;
            const uuidPart = document.getElementById('new-user-key').value;
            const comment = document.getElementById('new-user-comment').value;

            if(!uuidPart) {
                showToast("Сгенерируйте или введите UUID", "error");
                return;
            }

            const fullKey = "mini" + uuidPart;

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_key: adminKey,
                        key: fullKey,
                        comment: comment
                    })
                });

                if(!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || "Ошибка");
                }

                showToast(`Пользователь создан: ${fullKey}`);
                loadUsers();
                document.getElementById('new-user-key').value = '';
                document.getElementById('new-user-comment').value = '';

            } catch(e) {
                showToast(e.message, 'error');
            }
        }

        // Initialize admin check on load if key is pre-filled (browser autocomplete)
        setTimeout(() => {
             const key = document.getElementById('key').value;
             if(key) checkAdmin(key);
        }, 500);

    </script>
</body>
</html>
